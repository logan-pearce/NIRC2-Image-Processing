###############################################################################
#                                                                             #
#                        NIRC2 Image Processing pipeline                      #
#                                                                             #
#                        Written by Logan A. Pearce (2017)                    #
###############################################################################

################################ finding_darkflat.py ###########################
# Search through a folder of calibration images and find the ones that match your science images.
# Writes out a list of the file names for the dark frames and flat fields frames that match
# the science image.
# Input:
#   - Path + filename of science image to match the dark and flat frames to
#   - Path to folder containing calibration images to search for matches
# Output:
#   - List of dark images that match the science image's Multisam, Sampmode, ITime, and Coadds called "darklist"
#   - List of flat images that match the science image's filter called "flatlist"
# 
# First: make a list of all .fits files in the folder containing calibration images:
#     ls ~/Desktop/UTexas/Astro_research_data/data/GSC6214/2017_06_27/KOA_23637_cal/NIRC2/raw/cal/*.fits>list
# Next: execute "finding_darkflat.py" to search through those files for the ones that match the science frame:
#     python finding_darkflat.py ~/Desktop/UTexas/Astro_research_data/data/GSC6214/2017_06_27/N2.20170628.26771.fits
# Repeat for all calibration folders.  This script outputs two files in the science fram folder titled "darklist" and "flatlist"
# Next: Make a list of all the science frame images titled "objectlist" and put into the folder containing science frames:
#     ls ~/Desktop/UTexas/Astro_research_data/data/GSC6214/2017_06_27/*.fits>~/Desktop/UTexas/Astro_research_data/data/GSC6214/2017_06_27/objectlist
# Last: run the image process script on all science frames:
#     python image_process.py ~/Desktop/UTexas/Astro_research_data/data/GSC6214/2017_06_27/

################################ image_process.py ###########################
# Pipeline for cleaning NIRC2 images for analysis.  The pipeline first creates a master dark
# frame by linearizing and median-combining dark frames, then a master flat by linearizing, dark-subtracting,
# and then median-combining flat frames.  It then dark-substracts and flat-divides the science images.
# Then the pipeline imports a list of known bad pixels for NIRC2 replaces them with the mean of
# surrounding pixels.
#
# Inputs:
#  All located in the same directory as this script:
#  - A list of science images called "objectlist" (generated by running the "finding_object.py" script)
#  - A list of dark frames called "darklist" (from "finding_darkflat.py")
#  - A list of flat frames called "flatlist" (from "finding_darkflat.py")
#  - A list of known bad pixels for NIRC2 for both 1024x1024 and 512x512 images
# 
# Outputs:
#  - Cleaned science images as .fits files in the same directory as the raw image
#
# From the terminal, execute as follows:
# python image_process.py ~/Desktop/UTexas/Astro_research_data/data/GSC6214/2009_05_31/
#